from datetime import datetime
import subprocess
import daemon.daemon as daemon
import configuration
import timetable.utils
import utils

access_denied = '‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤'
greeting = '–î–æ–±—Ä—ã–π –¥–µ–Ω—å!'

resize_incorrect_format = """‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:
            
/resize lesson 1 +20min 
–£–¥–ª–∏–Ω—è–µ—Ç —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –ø–µ—Ä–≤—ã–π —É—Ä–æ–∫ –Ω–∞ 20 –º–∏–Ω—É—Ç

/resize 22.09.2006 break 4 -5min
–£–∫–æ—Ä–∞—á–∏–≤–∞–µ—Ç —á–µ—Ç–≤–µ—Ä—Ç—É—é –ø–µ—Ä–µ–º–µ–Ω—É –Ω–∞ –∑–∞–¥–∞–Ω–Ω—É—é –¥–∞—Ç—É –Ω–∞ –ø—è—Ç—å –º–∏–Ω—É—Ç"""

mute_incorrect_format =  """‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:
            
/mute 10:40 
–ó–∞–≥–ª—É—à–∞–µ—Ç –∑–≤–æ–Ω–æ–∫ –≤ 10:40 –Ω–∞ —Å–µ–≥–æ–¥–Ω—è

/mute 22.09.2006 10:40 
–ó–∞–≥–ª—É—à–∞–µ—Ç –∑–≤–æ–Ω–æ–∫ –≤ 10:40 –Ω–∞ –∑–∞–¥–∞–Ω–Ω—É—é –¥–∞—Ç—É"""

unmute_incorrect_format = """‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:
            
/unmute 10:40 
–£–±–∏—Ä–∞–µ—Ç –≥–ª—É—à–µ–Ω–∏–µ —Å –∑–≤–æ–Ω–æ–∫–∞ –≤ 10:40 –Ω–∞ —Å–µ–≥–æ–¥–Ω—è

/unmute 22.09.2006 10:40 
–£–±–∏—Ä–∞–µ—Ç –≥–ª—É—à–µ–Ω–∏–µ —Å –∑–≤–æ–Ω–æ–∫–∞ –≤ 10:40 –Ω–∞ –∑–∞–¥–∞–Ω–Ω—É—é –¥–∞—Ç—É"""

shift_incorrect_format =  """‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:
            
/shift +10min 
–°–¥–≤–∏–≥–∞–µ—Ç —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ 10 –º–∏–Ω—É—Ç –≤–ø–µ—Ä—ë–¥

/shift 22.09.2006 -2h
–°–¥–≤–∏–≥–∞–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤ –∑–∞–¥–∞–Ω–Ω—É—é –¥–∞—Ç—É –Ω–∞ 2 —á–∞—Å–∞ –Ω–∞–∑–∞–¥"""

pre_ring_incorrect_format = """‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:
            
/pre_ring_edit 5 
–ó–∞ 5 –º–∏–Ω—É—Ç –¥–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞ –±—É–¥–µ—Ç –ø–æ–¥–∞–Ω –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π
"""

set_timetable_first = """–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –ø–æ –æ–¥–Ω–æ–º—É –∏–∑ —à–∞–±–ª–æ–Ω–æ–≤
        1. –°–¥–≤–∏–≥–æ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç(https://docs.github.com/......)
        2. –ê–±—Å–æ–ª—é—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç(https://docs.github.com/.....)

‚ùó –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, —á—Ç–æ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ –≤—Å–µ –¥–Ω–∏ —É–¥–∞–ª—è—Ç—Å—è
        """

lesson_duration_incorrect_format = """‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:

/lesson_duration -10min
–£–º–µ–Ω—å—à–∞–µ—Ç –¥–ª–∏–Ω—É –≤—Å–µ—Ö —É—Ä–æ–∫–æ–≤ —Å–µ–≥–æ–¥–Ω—è –Ω–∞ 10 –º–∏–Ω—É—Ç

/lesson_duration 22.09.2006 +5min
–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –¥–ª–∏–Ω—É –≤—Å–µ—Ö —É—Ä–æ–∫–æ–≤ –Ω–∞ 5 –º–∏–Ω—É—Ç –≤ –∑–∞–¥–∞–Ω–Ω—ã–π –¥–µ–Ω—å
"""

break_duration_incorrect_format ="""‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:

/break_duration -10min
–£–º–µ–Ω—å—à–∞–µ—Ç –¥–ª–∏–Ω—É –≤—Å–µ—Ö –ø–µ—Ä–µ–º–µ–Ω —Å–µ–≥–æ–¥–Ω—è –Ω–∞ 10 –º–∏–Ω—É—Ç

/break_duration 22.09.2006 +5min
–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –¥–ª–∏–Ω—É –≤—Å–µ—Ö –ø–µ—Ä–µ–º–µ–Ω –Ω–∞ 5 –º–∏–Ω—É—Ç –≤ –∑–∞–¥–∞–Ω–Ω—ã–π –¥–µ–Ω—å
"""

add_receiver_incorrect_format = f"""‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:

/add_receiver 19291929
–î–æ–±–∞–≤–ª—è–µ—Ç –≤ —Å–ª—É—à–∞—Ç–µ–ª–µ–π —á–µ–ª–æ–≤–µ–∫–∞ —Å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º 19291929
"""


about = "BrigeBell146 - —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–∏—Å—Ç–µ–º—ã BellBrige –¥–ª—è –ú–ê–û–£ –°–û–® ‚Ññ146 —Å —É–≥–ª—É–±–ª—ë–Ω–Ω—ã–º –∏–∑—É—á–µ–Ω–∏–µ–º —Ñ–∏–∑–∏–∫–∏, –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏, –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∏ –≥. –ü–µ—Ä–º–∏"

def get_state_reply(daemon: daemon.Daemon) -> str: 
    daemon.update_ring_order()
    nearest, table = daemon.order, daemon.today_timetable
    nowEvent = "Off"

    print(nearest)
    if nearest != -1:
        thisPeriod = 0
        nextPeriod = 0
        nowEvent = "Off"
        if nearest != 0:
            hours, minutes = map(int, table[nearest-1].split(':'))
            difference = list(map(int, timetable.utils.sub_times(table[nearest], hours * 3600 + minutes * 60).split(":")))
            thisPeriod = str(difference[0] * 60 + difference[1]) + " –º–∏–Ω"
            if nearest % 2 == 0:
                nowEvent = "–ø–µ—Ä–µ–º–µ–Ω–∞"
            else:
                nowEvent = "—É—Ä–æ–∫"
        if nearest == len(table)-1:
            nextPeriod = "–Ω–∏—Å–∫–æ–ª—å–∫–æ"
        else:
            hours, minutes = map(int, table[nearest].split(':'))
            difference = list(map(int, timetable.utils.sub_times(table[nearest+1], hours * 3600 + minutes * 60).split(":")))
            nextPeriod = str(difference[0] * 60 + difference[1]) + " –º–∏–Ω"
        if nowEvent == "Off":
            thisPeriod = "–Ω–∏—Å–∫–æ–ª—å–∫–æ"
        current_rings = ('–¢–µ–∫—É—â–∏–π ' if nowEvent == '—É—Ä–æ–∫' else '–¢–µ–∫—É—â–∞—è ') + nowEvent + ' –¥–ª–∏—Ç—Å—è ' + thisPeriod
    else:
        current_rings = '–°–µ–≥–æ–¥–Ω—è –±–æ–ª—å—à–µ –Ω–µ—Ç —É—Ä–æ–∫–æ–≤'
    
    ans = f'''ü§ñ –û—Ç—á—ë—Ç –æ—Ç {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}

üõé –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–≤–æ–Ω–∫–æ–≤: 
''' 

    ans += f'''–°–ª–µ–¥—É—é—â–∏–π –∑–≤–æ–Ω–æ–∫ –≤: {table[nearest]}
–°–µ–π—á–∞—Å: {nowEvent.capitalize()}
{current_rings}''' if nowEvent != 'Off' else '–°–µ–≥–æ–¥–Ω—è —É–∂–µ –Ω–µ –±—É–¥–µ—Ç –∑–≤–æ–Ω–∫–æ–≤'

    ans += f'''

‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
–ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞: –∑–∞ {configuration.pre_ring_delta // 60} –º–∏–Ω –¥–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ
–î–ª–∏–Ω–∞ –∑–≤–æ–Ω–∫–∞: {configuration.ring_duration} —Å
–î–ª–∏–Ω–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞: {configuration.pre_ring_duration} —Å

üíæ –°–∏—Å—Ç–µ–º–∞
–ê–ø—Ç–∞–π–º: {utils.get_uptime()}
–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: {utils.get_cpu_temp()}¬∞–°
–°—Ç–∞—Ç—É—Å: {configuration.status}

üï∏Ô∏è –î–µ–º–æ–Ω
–°–ø–∏—Å–æ–∫ –∑–≤–æ–Ω–∫–æ–≤: {daemon.today_timetable}
Mute-—Å–ø–∏—Å–æ–∫: {daemon.muted_rings}
'''
    return ans
